<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>California Infectious Disease Dashboard</title> <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""></script>
    <style>
        body {
            font-family: 'Inter', sans-serif; /* Using Inter font as a Tailwind default */
            background-color: #f3f4f6; /* Light gray background */
        }
        .filter-select {
            min-width: 150px;
        }
        .summary-card {
            background-color: white;
            border-radius: 0.5rem; /* rounded-lg */
            padding: 1.5rem; /* p-6 */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* shadow-md */
        }
        .chart-container {
            position: relative;
            height: 400px; /* Consistent height for charts */
            width: 100%; /* Ensure chart container takes full width of its parent */
        }
        /* Ensure canvas elements take up the full space of their container */
        .chart-container canvas {
            display: block;
            width: 100%;
            height: 100%;
        }
        #map-container { /* Ensure map container has a defined height */
            height: 400px;
            width: 100%;
            border-radius: 0.5rem; /* Consistent rounding */
        }

        @media (max-width: 768px) { /* Mobile responsiveness */
            .filters-grid {
                grid-template-columns: repeat(2, minmax(0, 1fr)); /* 2 columns on mobile */
            }
            .summary-grid {
                grid-template-columns: repeat(1, minmax(0, 1fr)); /* 1 column on mobile */
            }
            .chart-container {
                height: 300px; /* Adjust chart height for smaller screens */
            }
            #map-container {
                height: 300px; /* Adjust map height for smaller screens */
            }
        }
    </style>
</head>
<body class="bg-gray-100 p-4 md:p-8">

    <div class="container mx-auto">
        <header class="mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">California Infectious Disease Dashboard</h1>
            <p class="text-gray-600">Data from 2001-2023 (Provisional)</p>
        </header>

        <section id="filters" class="mb-8 p-6 bg-white rounded-lg shadow-lg">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Filters</h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4 items-end filters-grid">
                <div>
                    <label for="disease-filter" class="block text-sm font-medium text-gray-700">Disease</label>
                    <select id="disease-filter" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 filter-select">
                        <option value="">All Diseases</option>
                    </select>
                </div>
                <div>
                    <label for="county-filter" class="block text-sm font-medium text-gray-700">County</label>
                    <select id="county-filter" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 filter-select">
                        <option value="">All Counties</option>
                    </select>
                </div>
                <div>
                    <label for="year-filter" class="block text-sm font-medium text-gray-700">Year</label>
                    <select id="year-filter" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 filter-select">
                        <option value="">All Years</option>
                    </select>
                </div>
                <div>
                    <label for="sex-filter" class="block text-sm font-medium text-gray-700">Sex</label>
                    <select id="sex-filter" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 filter-select">
                        <option value="">All</option>
                    </select>
                </div>
                <button id="clear-filters-btn" class="w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-md shadow-sm transition duration-150 ease-in-out self-end">
                    Clear Filters
                </button>
            </div>
        </section>

        <section id="summary-stats" class="mb-8 grid grid-cols-1 md:grid-cols-3 gap-4 summary-grid">
            <div class="summary-card text-center">
                <h3 class="text-lg font-medium text-gray-500">Total Cases</h3>
                <p id="total-cases" class="text-3xl font-bold text-indigo-600">0</p>
            </div>
            <div class="summary-card text-center">
                <h3 class="text-lg font-medium text-gray-500">First Reported Year</h3>
                <p id="first-reported" class="text-3xl font-bold text-indigo-600">N/A</p>
            </div>
            <div class="summary-card text-center">
                <h3 class="text-lg font-medium text-gray-500">Last Reported Year</h3>
                <p id="last-reported" class="text-3xl font-bold text-indigo-600">N/A</p>
            </div>
        </section>

        <section class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Filtered Data Breakdown</h2>
                <div class="chart-container">
                    <canvas id="barChart"></canvas>
                </div>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-lg">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Cases by County Map</h2>
                <div id="map-container" class="w-full border border-gray-200 rounded-md">
                </div>
            </div>
        </section>

        <section class="bg-white p-6 rounded-lg shadow-lg mt-8">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Cases Over Time</h2>
            <div class="chart-container">
                <canvas id="lineChart"></canvas>
            </div>
        </section>

        <footer class="mt-12 text-center text-sm text-gray-500">
            <p>Data Source: `idb_2001-2023.json` (California Department of Public Health - Provisional).</p>
            <p>Map Data: `california-counties.geojson`.</p>
            <p>This dashboard is for informational purposes. Always consult official sources for health data.</p>
        </footer>
    </div>

    <script>
        // --- DATA LOADING ---
        let masterData = []; 

        // --- DOM ELEMENT REFERENCES ---
        const diseaseFilter = document.getElementById('disease-filter');
        const countyFilter = document.getElementById('county-filter');
        const yearFilter = document.getElementById('year-filter');
        const sexFilter = document.getElementById('sex-filter');
        const clearFiltersBtn = document.getElementById('clear-filters-btn');

        const totalCasesEl = document.getElementById('total-cases');
        const firstReportedEl = document.getElementById('first-reported');
        const lastReportedEl = document.getElementById('last-reported');
        
        const barChartCanvas = document.getElementById('barChart');
        let barChartInstance = null; 
        
        const lineChartCanvas = document.getElementById('lineChart');
        let lineChartInstance = null; 

        // --- MAP VARIABLES ---
        let map = null;
        let geojsonLayer = null;
        let californiaGeoJsonData = null;

        // --- STATE VARIABLES ---
        let isApplyingFilters = false; 

        // --- INITIALIZE DASHBOARD ---
        async function initializeDashboard() {
            try {
                const response = await fetch('idb_2001-2023.json');
                if (!response.ok) {
                    throw new Error(`Failed to fetch disease data: ${response.status} ${response.statusText}. Check file path and ensure it's hosted.`);
                }
                masterData = await response.json();

                if (!Array.isArray(masterData)) { 
                    console.warn("Disease data ('idb_2001-2023.json') is not an array. Dashboard might not function correctly.");
                    masterData = []; 
                } else if (masterData.length === 0) {
                    console.warn("Disease data is empty. Check 'idb_2001-2023.json'.");
                }

                populateFilters();
                await initializeMap(); 
                applyFilters(); 
                addEventListeners();

            } catch (error) {
                console.error("Error initializing dashboard:", error);
                totalCasesEl.textContent = 'Error';
                firstReportedEl.textContent = 'Error';
                lastReportedEl.textContent = 'Error';
                
                displayChartError(barChartCanvas, `Chart Error: ${error.message}`);
                displayChartError(lineChartCanvas, `Chart Error: ${error.message}`);
                const mapContainer = document.getElementById('map-container');
                if(mapContainer) mapContainer.innerHTML = `<p class="text-center text-red-500 p-4">Error loading dashboard: ${error.message}</p>`;
            }
        }

        // --- POPULATE FILTER DROPDOWNS ---
        function populateFilters() {
            diseaseFilter.innerHTML = '<option value="">All Diseases</option>';
            yearFilter.innerHTML = '<option value="">All Years</option>';
            sexFilter.innerHTML = '<option value="">All</option>';

            if (masterData.length === 0) return; 

            const diseases = [...new Set(masterData.map(item => item.Disease))].filter(Boolean).sort();
            const years = [...new Set(masterData.map(item => parseInt(item.Year)))].filter(y => !isNaN(y)).sort((a,b) => b-a);
            const sexes = [...new Set(masterData.map(item => item.Sex))].filter(Boolean).sort();

            diseases.forEach(d => {
                const option = document.createElement('option');
                option.value = d;
                option.textContent = d;
                diseaseFilter.appendChild(option);
            });
            years.forEach(y => {
                const option = document.createElement('option');
                option.value = y;
                option.textContent = y;
                yearFilter.appendChild(option);
            });
             sexes.forEach(s => {
                const option = document.createElement('option');
                option.value = s;
                option.textContent = s;
                sexFilter.appendChild(option);
            });
        }

        // --- ADD EVENT LISTENERS ---
        function addEventListeners() {
            diseaseFilter.addEventListener('change', applyFilters);
            countyFilter.addEventListener('change', applyFilters);
            yearFilter.addEventListener('change', applyFilters);
            sexFilter.addEventListener('change', applyFilters);
            clearFiltersBtn.addEventListener('click', () => {
                diseaseFilter.value = "";
                countyFilter.value = "";
                yearFilter.value = "";
                sexFilter.value = "";
                applyFilters();
            });
        }

        // --- APPLY FILTERS AND UPDATE DISPLAY ---
        function applyFilters() {
            if (isApplyingFilters) {
                console.warn("applyFilters() called while already running. Aborting to prevent recursion.");
                return; 
            }
            isApplyingFilters = true;

            try {
                const selectedDisease = diseaseFilter.value;
                const selectedCounty = countyFilter.value;
                const selectedYearStr = yearFilter.value; 
                const selectedSex = sexFilter.value;

                const filteredData = masterData.filter(item => {
                    const itemYear = parseInt(item.Year); 
                    return (selectedDisease ? item.Disease === selectedDisease : true) &&
                           (selectedCounty ? item.County === selectedCounty : true) &&
                           (selectedYearStr ? itemYear === parseInt(selectedYearStr) : true) && 
                           (selectedSex ? item.Sex === selectedSex : true);
                });

                updateSummaryStats(filteredData);
                updateBarChart(filteredData);
                updateLineChart(filteredData);
                updateMapVisualization(selectedCounty); 
            } catch (e) {
                console.error("Error during applyFilters processing:", e);
            } finally {
                isApplyingFilters = false; 
            }
        }

        // --- UPDATE SUMMARY STATISTICS ---
        function updateSummaryStats(data) {
            const totalCases = data.reduce((sum, item) => sum + (Number(item.Cases) || 0), 0);
            let firstReportedYear = 'N/A';
            let lastReportedYear = 'N/A';

            if (data.length > 0) {
                const yearsInData = data.map(item => parseInt(item.Year)).filter(year => !isNaN(year));
                if (yearsInData.length > 0) {
                    firstReportedYear = Math.min(...yearsInData).toString();
                    lastReportedYear = Math.max(...yearsInData).toString();
                }
            }

            totalCasesEl.textContent = totalCases.toLocaleString();
            firstReportedEl.textContent = firstReportedYear;
            lastReportedEl.textContent = lastReportedYear;
        }
        
        // --- UTILITY TO DISPLAY ERROR/NO DATA ON CHART CANVAS ---
        function displayChartError(canvas, message) {
            if (!canvas) {
                console.error("displayChartError called with null canvas");
                return;
            }

            // Ensure canvas drawing surface matches its styled size.
            // This is crucial if Chart.js hasn't initialized the canvas dimensions yet.
            if (canvas.width !== canvas.clientWidth || canvas.height !== canvas.clientHeight) {
                canvas.width = canvas.clientWidth;
                canvas.height = canvas.clientHeight;
            }

            const ctx = canvas.getContext('2d');
            
            // If canvas has no effective drawing area, exit.
            if (canvas.width === 0 || canvas.height === 0) {
                // console.warn(`Canvas ${canvas.id || 'Unnamed'} has zero dimensions. Cannot display message.`);
                return;
            }

            ctx.clearRect(0, 0, canvas.width, canvas.height); 
            ctx.font = "14px 'Inter', sans-serif";
            
            // Set text color based on message content
            if (message && (message.toLowerCase().includes("error") || message.toLowerCase().includes("failed"))) {
                ctx.fillStyle = "#ef4444"; // Tailwind text-red-500 for errors
            } else {
                ctx.fillStyle = "#6b7280"; // Tailwind text-gray-500 for "no data" messages
            }

            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle'; // Align text vertically to the middle

            const maxWidth = canvas.width - 40; // Max width for text with padding
            const lineHeight = 18;
            const words = (message || 'No data available.').split(' '); // Default message if none provided
            let lines = [];
            let currentLine = '';

            for (let n = 0; n < words.length; n++) {
                const testLine = currentLine + words[n] + ' ';
                const metrics = ctx.measureText(testLine);
                const testWidth = metrics.width;
                if (testWidth > maxWidth && currentLine.length > 0) { // Ensure currentLine is not empty before pushing
                    lines.push(currentLine.trim());
                    currentLine = words[n] + ' ';
                } else {
                    currentLine = testLine;
                }
            }
            lines.push(currentLine.trim());

            // Remove empty lines that might result from split and trim
            lines = lines.filter(line => line.length > 0);

            if (lines.length === 0) { // If message was empty or all spaces
                 lines.push('No data available.');
            }

            const totalTextHeight = lines.length * lineHeight;
            // Calculate starting Y position to center the block of text vertically
            let startY = (canvas.height - totalTextHeight) / 2 + (lineHeight / 2); // Add half lineHeight to align baseline correctly

            for (let i = 0; i < lines.length; i++) {
                ctx.fillText(lines[i], canvas.width / 2, startY + (i * lineHeight));
            }
        }


        // --- BAR CHART FOR FILTERED DATA ---
        function updateBarChart(data) {
            if (barChartInstance) {
                barChartInstance.destroy();
                barChartInstance = null; 
            }
            if (!barChartCanvas) {
                console.error("Bar chart canvas ('barChart') not found!");
                return;
            }

            const selectedDisease = diseaseFilter.value;
            const selectedCounty = countyFilter.value;
            const selectedYearStr = yearFilter.value;

            if (data.length === 0 && masterData.length > 0) { 
                displayChartError(barChartCanvas, 'No data for chart with current filters.');
                return;
            }
            if (masterData.length === 0 && data.length === 0){ 
                 displayChartError(barChartCanvas, 'No data available to display.');
                return;
            }

            const casesByCategory = {};
            const groupByKey = selectedYearStr ? 'County' : 'Year';
            
            data.forEach(item => {
                const categoryValue = item[groupByKey];
                if (!categoryValue) return; 
                if (!casesByCategory[categoryValue]) casesByCategory[categoryValue] = 0;
                casesByCategory[categoryValue] += (Number(item.Cases) || 0);
            });

            const categories = Object.keys(casesByCategory).sort((a, b) => {
                return groupByKey === 'Year' ? parseInt(a) - parseInt(b) : a.localeCompare(b);
            });
            
            if (categories.length === 0 && data.length > 0) { 
                displayChartError(barChartCanvas, 'Could not generate chart categories from data.');
                return;
            }
             // If categories is still empty here, it implies data was empty, which should have been caught above.
            // However, if data had items but none formed categories (e.g. all items missing 'County' or 'Year'),
            // and data.length > 0 was true, the above handles it.
            // If categories is empty because data was empty, displayChartError was already called.
            if (categories.length === 0) { // Final catch-all if no categories could be made (e.g. data became empty after processing)
                displayChartError(barChartCanvas, 'No categories to display for the chart.');
                return;
            }


            const chartData = {
                labels: categories,
                datasets: [{
                    label: 'Cases',
                    data: categories.map(category => casesByCategory[category]),
                    backgroundColor: 'rgba(59, 130, 246, 0.7)', 
                    borderColor: 'rgba(59, 130, 246, 1)',
                    borderWidth: 1,
                    borderRadius: 5, 
                }]
            };

            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: true, position: 'top' },
                    title: {
                        display: true,
                        text: `Cases ${selectedDisease ? 'for ' + selectedDisease : ''} ${selectedCounty ? 'in ' + selectedCounty : ''} ${selectedYearStr ? 'for ' + selectedYearStr : ''}`.trim() || 'Overall Cases Breakdown'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.dataset.label}: ${context.parsed.y.toLocaleString()}`;
                            }
                        }
                    }
                },
                scales: {
                    x: { title: { display: true, text: groupByKey } },
                    y: { title: { display: true, text: 'Number of Cases' }, beginAtZero: true, ticks: { callback: value => value.toLocaleString() } }
                }
            };

            barChartInstance = new Chart(barChartCanvas, {
                type: 'bar',
                data: chartData,
                options: chartOptions
            });
        }

    // --- MAP VISUALIZATION ---
    const BASE_COUNTY_STYLE = {
        color: "#4A5568", 
        weight: 1,
        opacity: 0.9,
        fillOpacity: 0.65
    };

    const HIGHLIGHTED_COUNTY_STYLE = { 
        ...BASE_COUNTY_STYLE,
        fillColor: "#3B82F6", 
        fillOpacity: 0.85,
        weight: 2.5,
        color: "#1D4ED8", 
    };
    
    function stringToColor(str) { 
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
            hash = str.charCodeAt(i) + ((hash << 5) - hash);
            hash = hash & hash;
        }
        let r = (hash & 0xFF0000) >> 16;
        let g = (hash & 0x00FF00) >> 8;
        let b = hash & 0x0000FF;
        r = 30 + (r % 195); 
        g = 30 + (g % 195);
        b = 30 + (b % 195);
        if (Math.abs(r - 59) < 30 && Math.abs(g - 130) < 30 && Math.abs(b - 246) < 30) {
            g = (g + 100) % 195 + 30; 
        }
        return "#" + ("000000" + ((r << 16) | (g << 8) | b).toString(16)).slice(-6);
    }


    async function initializeMap() {
        const mapContainer = document.getElementById('map-container');
        if (!mapContainer) {
            console.error("Map container not found!");
            return; 
        }
        mapContainer.innerHTML = ''; 

        const californiaBounds = [[32.5, -124.5], [42, -114.0]];
        if (map) {
            map.remove(); 
            map = null;
        }
        map = L.map('map-container', {
            center: [37.0, -119.5], zoom: 6, maxBounds: californiaBounds, minZoom: 5
        });

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 18
        }).addTo(map);

        try {
            const response = await fetch('california-counties.geojson'); 
            if (!response.ok) {
                throw new Error(`Failed to fetch GeoJSON: ${response.status} ${response.statusText}. Check file path and ensure it's hosted.`);
            }
            californiaGeoJsonData = await response.json();
            
            if (!californiaGeoJsonData || !californiaGeoJsonData.features || californiaGeoJsonData.features.length === 0) {
                console.warn("GeoJSON data is empty or invalid.");
                if(mapContainer) mapContainer.innerHTML = `<p class="text-center text-yellow-500 p-4">Map data (GeoJSON) is empty or invalid. Counties cannot be displayed.</p>`;
                return; 
            }

            if (countyFilter && californiaGeoJsonData && californiaGeoJsonData.features) {
                countyFilter.innerHTML = '<option value="">All Counties</option>'; 
                const countyNamesForDropdown = [];
                const countySet = new Set(); 
                californiaGeoJsonData.features.forEach(feature => {
                    const countyValue = feature.properties.name; 
                    const countyDisplayText = feature.properties.NAME || feature.properties.name; 
                    if (countyValue && !countySet.has(countyValue)) {
                        countySet.add(countyValue);
                        countyNamesForDropdown.push({ value: countyValue, text: countyDisplayText });
                    }
                });
                countyNamesForDropdown.sort((a, b) => a.text.localeCompare(b.text)); 
                countyNamesForDropdown.forEach(county => {
                    const option = document.createElement('option');
                    option.value = county.value;
                    option.textContent = county.text;
                    countyFilter.appendChild(option);
                });
            }

            if (geojsonLayer) { 
                map.removeLayer(geojsonLayer);
                geojsonLayer = null;
            }
            geojsonLayer = L.geoJson(californiaGeoJsonData, {
                style: function(feature) {
                    const countyId = feature.properties.name || 'UnknownCounty';
                    if (!feature.properties.defaultColor) { 
                        feature.properties.defaultColor = stringToColor(countyId + "salt"); 
                    }
                    return { ...BASE_COUNTY_STYLE, fillColor: feature.properties.defaultColor };
                },
                onEachFeature: function(feature, layer) {
                    const countyDisplayName = feature.properties.NAME || feature.properties.name || "N/A";
                    const countyValueForFiltering = feature.properties.name; 

                    layer.bindTooltip(() => {
                        const selectedDisease = diseaseFilter.value;
                        let tooltipContent = `<b>${countyDisplayName}</b>`;
                        
                        if (masterData.length > 0 && countyValueForFiltering) {
                            const currentFilters = { 
                                disease: diseaseFilter.value, // This is selectedDisease, kept for clarity
                                year: yearFilter.value,
                                sex: sexFilter.value
                            };

                            const casesInCountyAllDiseases = masterData
                                .filter(item => item.County === countyValueForFiltering &&
                                               (currentFilters.year ? parseInt(item.Year) === parseInt(currentFilters.year) : true) &&
                                               (currentFilters.sex ? item.Sex === currentFilters.sex : true)
                                )
                                .reduce((sum, item) => sum + (Number(item.Cases) || 0), 0);
                            
                            tooltipContent += `<br>Total Cases (active filters): ${casesInCountyAllDiseases.toLocaleString()}`;

                            if (selectedDisease) { 
                                 const casesForSelectedDisease = masterData
                                    .filter(item => item.County === countyValueForFiltering && 
                                                   item.Disease === selectedDisease &&
                                                   (currentFilters.year ? parseInt(item.Year) === parseInt(currentFilters.year) : true) &&
                                                   (currentFilters.sex ? item.Sex === currentFilters.sex : true)
                                    )
                                    .reduce((sum, item) => sum + (Number(item.Cases) || 0), 0);
                                tooltipContent += `<br>${selectedDisease}: ${casesForSelectedDisease.toLocaleString()}`;
                            }
                        } else if (!countyValueForFiltering) {
                            tooltipContent += "<br>County name missing in GeoJSON."
                        } else if (masterData.length === 0) {
                            tooltipContent += "<br>Disease data not loaded."
                        }
                        return tooltipContent;
                    });

                    layer.on('click', function(e) {
                        if (countyValueForFiltering) {
                            countyFilter.value = countyValueForFiltering;
                            applyFilters(); 
                        }
                    });
                }
            }).addTo(map);

        } catch (error) {
            console.error("Error loading or processing GeoJSON for map:", error);
            if(mapContainer) mapContainer.innerHTML = `<p class="text-center text-red-500 p-4">Could not load map data: ${error.message}. Ensure 'california-counties.geojson' is present and valid. Check console.</p>`;
        }
    }

    function updateMapVisualization(selectedCountyName) {
        if (!geojsonLayer || !map) return;

        let highlightedLayer = null;
        geojsonLayer.eachLayer(function(layer) {
            const geoJsonCountyName = layer.feature.properties.name; 

            if (geoJsonCountyName && selectedCountyName && geoJsonCountyName.toLowerCase() === selectedCountyName.toLowerCase()) {
                layer.setStyle(HIGHLIGHTED_COUNTY_STYLE);
                layer.bringToFront();
                highlightedLayer = layer;
            } else {
                const defaultColor = layer.feature.properties.defaultColor || stringToColor((geoJsonCountyName || "unknown") + "salt");
                layer.setStyle({ ...BASE_COUNTY_STYLE, fillColor: defaultColor });
            }
        });

        if (highlightedLayer) {
            map.fitBounds(highlightedLayer.getBounds(), { paddingTopLeft: [20,20], paddingBottomRight: [20,20], maxZoom: 8 });
        } else if (!selectedCountyName && californiaGeoJsonData && geojsonLayer.getLayers().length > 0) { 
             if (geojsonLayer.getBounds().isValid()) {
                map.fitBounds(geojsonLayer.getBounds());
            } else {
                map.setView([37.0, -119.5], 6); 
            }
        } else if (!selectedCountyName) { 
            map.setView([37.0, -119.5], 6);
        }
    }

        // --- LINE CHART FOR CASES OVER TIME ---
        function updateLineChart(data) {
            if (lineChartInstance) {
                lineChartInstance.destroy();
                lineChartInstance = null; 
            }
            if (!lineChartCanvas) {
                console.error("Line chart canvas ('lineChart') not found!");
                return;
            }
            
            if (data.length === 0 && masterData.length > 0) {
                displayChartError(lineChartCanvas, 'No data for line chart with current filters.');
                return;
            }
             if (masterData.length === 0 && data.length === 0){
                 displayChartError(lineChartCanvas, 'No data available to display.');
                return;
            }

            const hasMonthData = data.length > 0 && data.some(item => typeof item.Month !== 'undefined' && item.Month !== null && !isNaN(parseInt(item.Month)));
            const casesByTimeKey = {};

            data.forEach(item => {
                const year = parseInt(item.Year);
                const month = parseInt(item.Month); 
                let timeKey;

                if (hasMonthData && !isNaN(year) && !isNaN(month) && month >= 1 && month <= 12) {
                    timeKey = `${year}-${String(month).padStart(2, '0')}`; 
                } else if (!isNaN(year)) {
                    timeKey = String(year); 
                } else {
                    return; 
                }
                
                if (!casesByTimeKey[timeKey]) casesByTimeKey[timeKey] = 0;
                casesByTimeKey[timeKey] += (Number(item.Cases) || 0);
            });

            const timeKeys = Object.keys(casesByTimeKey).sort(); 

            if (timeKeys.length === 0 && data.length > 0) {
                 displayChartError(lineChartCanvas, 'Could not generate time series from data.');
                return;
            }
            if (timeKeys.length === 0) { // If no time keys, display message
                 displayChartError(lineChartCanvas, 'No time series data to display for current filters.');
                return;
            }

            const chartData = {
                labels: timeKeys,
                datasets: [{
                    label: 'Cases',
                    data: timeKeys.map(key => casesByTimeKey[key]),
                    borderColor: 'rgba(16, 185, 129, 0.8)', 
                    backgroundColor: 'rgba(16, 185, 129, 0.2)', 
                    fill: true,
                    tension: 0.1 
                }]
            };

            lineChartInstance = new Chart(lineChartCanvas, {
                type: 'line',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true, position: 'top' },
                        title: { display: true, text: 'Cases Over Time' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y.toLocaleString()}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: { title: { display: true, text: hasMonthData ? 'Year-Month' : 'Year' } },
                        y: { title: { display: true, text: 'Number of Cases' }, beginAtZero: true, ticks: { callback: value => value.toLocaleString() } }
                    }
                }
            });
        }

        // --- RUN INITIALIZATION ON PAGE LOAD ---
        document.addEventListener('DOMContentLoaded', initializeDashboard);

    </script>
</body>
</html>
