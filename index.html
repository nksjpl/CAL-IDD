<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""/>
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""></script>
    <style>
        /* Your custom styles here */
        .summary-card { padding: 1rem; background: white; border-radius: 0.5rem; box-shadow: 0 0 1rem rgba(0,0,0,0.1); }
        .chart-container { position: relative; height: 400px; width: 100%; }
        #map-container { height: 400px; width: 100%; }
    </style>
    <title>California IDD Dashboard</title>
</head>
<body class="bg-gray-100 p-6">
    <header class="mb-8">
        <h1 class="text-3xl font-bold text-gray-800">California IDD Dashboard</h1>
        <p class="text-gray-600">Interactive visualization of Infectious Disease Data (2001-2023)</p>
    </header>

    <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div>
            <label for="disease-filter" class="block text-sm font-medium text-gray-700">Disease</label>
            <select id="disease-filter" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 filter-select">
                <option value="">All Diseases</option>
            </select>
        </div>
        <div>
            <label for="county-filter" class="block text-sm font-medium text-gray-700">County</label>
            <select id="county-filter" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 filter-select">
                <option value="">All Counties</option>
            </select>
        </div>
        <div>
            <label for="year-filter" class="block text-sm font-medium text-gray-700">Year</label>
            <select id="year-filter" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 filter-select">
                <option value="">All Years</option>
            </select>
        </div>
        <div>
            <label for="sex-filter" class="block text-sm font-medium text-gray-700">Sex</label>
            <select id="sex-filter" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 filter-select">
                <option value="">All</option>
                <!-- Options will be populated by JavaScript if needed, or can be static -->
            </select>
        </div>
    </section>

    <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="summary-card text-center">
            <h3 class="text-lg font-medium text-gray-500">Total Cases</h3>
            <p id="total-cases" class="text-3xl font-bold text-indigo-600">0</p>
        </div>
        <div class="summary-card text-center">
            <h3 class="text-lg font-medium text-gray-500">First Reported</h3>
            <p id="first-reported" class="text-3xl font-bold text-indigo-600">N/A</p>
        </div>
        <div class="summary-card text-center">
            <h3 class="text-lg font-medium text-gray-500">Last Reported</h3>
            <p id="last-reported" class="text-3xl font-bold text-indigo-600">N/A</p>
        </div>
    </section>

    <section class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Bar Chart Visualization -->
        <div class="bg-white p-6 rounded-lg shadow-lg">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Filtered Data (Bar Chart)</h2>
            <div class="chart-container">
                <canvas id="barChart"></canvas>
            </div>
        </div>

        <!-- Map Visualization -->
        <div class="bg-white p-6 rounded-lg shadow-lg">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Cases by County</h2>
            <div id="map-container" class="h-96 w-full border border-gray-200 rounded-md"></div>
        </div>
    </section>

    <section class="bg-white p-6 rounded-lg shadow-lg mt-8">
        <h2 class="text-xl font-semibold text-gray-700 mb-4">Cases Over Time</h2>
        <div class="chart-container">
            <canvas id="timeChart"></canvas>
        </div>
    </section>

    <script>
        // Main dashboard initialization
        async function initializeDashboard() {
            try {
                // Fetch data from the JSON file
                const response = await fetch('./idb_2001-2023.json');
                if (!response.ok) throw new Error('Failed to fetch idb_2001-2023.json');
                const masterData = await response.json();
                if (!Array.isArray(masterData)) {
                    console.warn("Master data is empty or not an array. Check './idb_2001-2023.json'.");
                    return;
                }

                // Populate filters
                populateFilters(masterData);
                applyFilters(masterData);

                // Initialize the map after data is ready
                await initializeMap(masterData);

                // Attach event listeners
                addEventListeners(masterData);
            } catch (error) {
                console.error("Error initializing dashboard:", error);
                document.getElementById('total-cases').textContent = 'Error';
            }
        }

        function populateFilters(data) {
            const diseaseFilter = document.getElementById('disease-filter');
            const countyFilter = document.getElementById('county-filter');
            const yearFilter = document.getElementById('year-filter');
            const sexFilter = document.getElementById('sex-filter');

            // Helper to create options
            const createOptions = (set) => Array.from(set).sort().map(value => {
                const opt = document.createElement('option');
                opt.value = value;
                opt.textContent = value;
                return opt;
            });

            // Data domains
            const diseases = new Set(data.map(item => item.Disease));
            const counties = new Set(data.map(item => item.County));
            const years = new Set(data.map(item => item.Year));
            const sexes = new Set(data.map(item => item.Sex));

            // Populate
            createOptions(diseases).forEach(opt => diseaseFilter.appendChild(opt));
            createOptions(counties).forEach(opt => countyFilter.appendChild(opt));
            createOptions(years).forEach(opt => yearFilter.appendChild(opt));
            createOptions(sexes).forEach(opt => sexFilter.appendChild(opt));
        }

        function applyFilters(data) {
            const disease = document.getElementById('disease-filter').value;
            const county = document.getElementById('county-filter').value;
            const year = document.getElementById('year-filter').value;
            const sex = document.getElementById('sex-filter').value;

            let filtered = data;
            if (disease) filtered = filtered.filter(d => d.Disease === disease);
            if (county) filtered = filtered.filter(d => d.County === county);
            if (year) filtered = filtered.filter(d => String(d.Year) === year);
            if (sex) filtered = filtered.filter(d => d.Sex === sex);

            updateSummary(filtered);
            updateBarChart(filtered);
            updateTimeChart(filtered);
        }

        async function initializeMap(data) {
            const map = L.map('map-container').setView([36.7783, -119.4179], 6);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            const geoResponse = await fetch('./california-counties.geojson');
            if (!geoResponse.ok) throw new Error('Failed to fetch california-counties.geojson');
            const geoData = await geoResponse.json();

            L.geoJSON(geoData, {
                style: (feature) => ({ color: '#3b82f6', weight: 1, fillOpacity: 0.2 })
            }).addTo(map);
        }

        function addEventListeners(data) {
            document.querySelectorAll('.filter-select').forEach(el => {
                el.addEventListener('change', () => applyFilters(data));
            });
        }

        function updateSummary(data) {
            const total = data.reduce((sum, i) => sum + Number(i.Cases || 0), 0);
            document.getElementById('total-cases').textContent = total;
            if (data.length) {
                const dates = data.map(i => new Date(i.Date));
                document.getElementById('first-reported').textContent = new Date(Math.min(...dates)).toLocaleDateString();
                document.getElementById('last-reported').textContent = new Date(Math.max(...dates)).toLocaleDateString();
            } else {
                document.getElementById('first-reported').textContent = 'N/A';
                document.getElementById('last-reported').textContent = 'N/A';
            }
        }

        function updateBarChart(data) {
            const ctx = document.getElementById('barChart').getContext('2d');
            if (window.barChart) window.barChart.destroy();
            const counts = {};
            data.forEach(i => counts[i.Disease] = (counts[i.Disease] || 0) + Number(i.Cases || 0));
            window.barChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: Object.keys(counts), datasets: [{ label: '# of Cases', data: Object.values(counts) }] },
                options: { scales: { y: { beginAtZero: true } } }
            });
        }

        function updateTimeChart(data) {
            const ctx = document.getElementById('timeChart').getContext('2d');
            if (window.timeChart) window.timeChart.destroy();
            const grouped = {};
            data.forEach(i => {
                const dateKey = new Date(i.Date).getFullYear();
                grouped[dateKey] = (grouped[dateKey] || 0) + Number(i.Cases || 0);
            });
            window.timeChart = new Chart(ctx, {
                type: 'line',
                data: { labels: Object.keys(grouped).sort(), datasets: [{ label: 'Cases Over Time', data: Object.values(grouped) }] },
                options: { scales: { y: { beginAtZero: true } } }
            });
        }

        document.addEventListener('DOMContentLoaded', initializeDashboard);
    </script>
</body>
</html>
