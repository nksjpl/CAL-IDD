<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""/>
    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""></script>
    <style>
        .summary-card { padding: 1rem; background: white; border-radius: 0.5rem; box-shadow: 0 0 1rem rgba(0,0,0,0.1); }
        .chart-container { position: relative; height: 400px; width: 100%; }
        #map-container { height: 400px; width: 100%; }
    </style>
    <title>California IDD Dashboard</title>
</head>
<body class="bg-gray-100 p-6">
    <header class="mb-8">
        <h1 class="text-3xl font-bold text-gray-800">California IDD Dashboard</h1>
        <p class="text-gray-600">Interactive visualization of Infectious Disease Data (2001-2023)</p>
    </header>

    <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div>
            <label for="disease-filter" class="block text-sm font-medium text-gray-700">Disease</label>
            <select id="disease-filter" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 filter-select">
                <option value="">All Diseases</option>
                <!-- Options will be populated by JavaScript -->
            </select>
        </div>
        <div>
            <label for="county-filter" class="block text-sm font-medium text-gray-700">County</label>
            <select id="county-filter" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 filter-select">
                <option value="">All Counties</option>
            </select>
        </div>
        <div>
            <label for="year-filter" class="block text-sm font-medium text-gray-700">Year</label>
            <select id="year-filter" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 filter-select">
                <option value="">All Years</option>
            </select>
        </div>
        <div>
            <label for="sex-filter" class="block text-sm font-medium text-gray-700">Sex</label>
            <select id="sex-filter" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 filter-select">
                <option value="">All</option>
            </select>
        </div>
    </section>

    <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <div class="summary-card text-center">
            <h3 class="text-lg font-medium text-gray-500">Total Cases</h3>
            <p id="total-cases" class="text-3xl font-bold text-indigo-600">Loading...</p>
        </div>
        <div class="summary-card text-center">
            <h3 class="text-lg font-medium text-gray-500">First Reported</h3>
            <p id="first-reported" class="text-3xl font-bold text-indigo-600">Loading...</p>
        </div>
        <div class="summary-card text-center">
            <h3 class="text-lg font-medium text-gray-500">Last Reported</h3>
            <p id="last-reported" class="text-3xl font-bold text-indigo-600">Loading...</p>
        </div>
    </section>

    <section class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <div class="bg-white p-6 rounded-lg shadow-lg">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Filtered Data (Bar Chart)</h2>
            <div class="chart-container">
                <canvas id="barChart"></canvas>
            </div>
        </div>

        <div class="bg-white p-6 rounded-lg shadow-lg">
            <h2 class="text-xl font-semibold text-gray-700 mb-4">Cases by County</h2>
            <div id="map-container" class="h-96 w-full border border-gray-200 rounded-md"></div>
        </div>
    </section>

    <section class="bg-white p-6 rounded-lg shadow-lg mt-8">
        <h2 class="text-xl font-semibold text-gray-700 mb-4">Cases Over Time</h2>
        <div class="chart-container">
            <canvas id="timeChart"></canvas>
        </div>
    </section>

    <script>
        // Determine base path for GitHub Pages
        function getBasePath() {
            const origin = window.location.origin;
            const segments = window.location.pathname.split('/');
            const repo = segments[1] || '';
            return `${origin}/${repo}/`;
        }
        const basePath = getBasePath();

        async function initializeDashboard() {
            try {
                // Fetch data JSON
                const dataUrl = `${basePath}idb_2001-2023.json`;
                const response = await fetch(dataUrl);
                if (!response.ok) throw new Error(`Failed to fetch ${dataUrl}: ${response.status}`);
                const masterData = await response.json();
                if (!Array.isArray(masterData)) throw new Error('Data loaded is not an array');

                // Populate filters and initial render
                populateFilters(masterData);
                applyFilters(masterData);

                // Initialize map
                await initializeMap(masterData);
                addEventListeners(masterData);
            } catch (err) {
                console.error('Dashboard init error:', err);
                document.getElementById('total-cases').textContent = 'Error';
                document.getElementById('first-reported').textContent = 'Error';
                document.getElementById('last-reported').textContent = 'Error';
            }
        }

        function populateFilters(data) {
            const diseaseFilter = document.getElementById('disease-filter');
            const countyFilter = document.getElementById('county-filter');
            const yearFilter = document.getElementById('year-filter');
            const sexFilter = document.getElementById('sex-filter');
            const createOptions = (set, selectEl) => Array.from(set).sort().forEach(val => {
                const opt = document.createElement('option'); opt.value = val; opt.textContent = val;
                selectEl.appendChild(opt);
            });

            createOptions(new Set(data.map(d => d.Disease)), diseaseFilter);
            createOptions(new Set(data.map(d => d.County)), countyFilter);
            createOptions(new Set(data.map(d => d.Year)), yearFilter);
            createOptions(new Set(data.map(d => d.Sex)), sexFilter);
        }

        function applyFilters(data) {
            const filters = {
                Disease: document.getElementById('disease-filter').value,
                County: document.getElementById('county-filter').value,
                Year: document.getElementById('year-filter').value,
                Sex: document.getElementById('sex-filter').value
            };
            let filtered = data.filter(d =>
                (!filters.Disease || d.Disease === filters.Disease) &&
                (!filters.County || d.County === filters.County) &&
                (!filters.Year || String(d.Year) === filters.Year) &&
                (!filters.Sex || d.Sex === filters.Sex)
            );

            updateSummary(filtered);
            updateBarChart(filtered);
            updateTimeChart(filtered);
        }

        async function initializeMap(data) {
            const map = L.map('map-container').setView([36.7783, -119.4179], 6);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);

            const geoUrl = `${basePath}california-counties.geojson`;
            const geoResp = await fetch(geoUrl);
            if (!geoResp.ok) throw new Error(`Failed to fetch ${geoUrl}`);
            const geoData = await geoResp.json();
            L.geoJSON(geoData, { style: f => ({ color: '#3b82f6', weight: 1, fillOpacity: 0.2 }) }).addTo(map);
        }

        function addEventListeners(data) {
            document.querySelectorAll('.filter-select').forEach(el => el.addEventListener('change', () => applyFilters(data)));
        }

        function updateSummary(data) {
            const total = data.reduce((sum, r) => sum + Number(r.Cases || 0), 0);
            document.getElementById('total-cases').textContent = total;

            if (data.length) {
                const dates = data.map(r => new Date(r.Date)).filter(d => !isNaN(d));
                const min = new Date(Math.min(...dates));
                const max = new Date(Math.max(...dates));
                document.getElementById('first-reported').textContent = isNaN(min) ? 'N/A' : min.toLocaleDateString();
                document.getElementById('last-reported').textContent = isNaN(max) ? 'N/A' : max.toLocaleDateString();
            } else {
                document.getElementById('first-reported').textContent = 'N/A';
                document.getElementById('last-reported').textContent = 'N/A';
            }
        }

        function updateBarChart(data) {
            const ctx = document.getElementById('barChart').getContext('2d');
            if (window.barChart) window.barChart.destroy();
            const counts = {};
            data.forEach(r => counts[r.Disease] = (counts[r.Disease]||0) + Number(r.Cases||0));
            window.barChart = new Chart(ctx, { type: 'bar', data: { labels: Object.keys(counts), datasets: [{ label: 'Cases', data: Object.values(counts) }] }, options: { scales: { y: { beginAtZero: true } } } });
        }

        function updateTimeChart(data) {
            const ctx = document.getElementById('timeChart').getContext('2d');
            if (window.timeChart) window.timeChart.destroy();
            const grouped = {};
            data.forEach(r => {
                const year = new Date(r.Date).getFullYear();
                grouped[year] = (grouped[year]||0) + Number(r.Cases||0);
            });
            const labels = Object.keys(grouped).sort();
            window.timeChart = new Chart(ctx, { type: 'line', data: { labels, datasets: [{ label: 'Cases Over Time', data: labels.map(y=>grouped[y]) }] }, options: { scales: { y: { beginAtZero: true } } } });
        }

        document.addEventListener('DOMContentLoaded', initializeDashboard);
    </script>
</body>
</html>
